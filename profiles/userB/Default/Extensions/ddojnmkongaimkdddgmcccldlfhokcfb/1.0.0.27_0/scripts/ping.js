const CHANNEL="Channel",MACHINE_ID="MachineID",PARTNER_CODE="PartnerCode",DPC="DPC",MARKET="Market",BLOCKING_URL_DDOJ="*://www.bing.com/search?EID=MBHSC&form=BGGCMF&pc=BG00*",BLOCKING_URL_DDOJ_HOMEPAGE="*://www.bing.com/*?pc=BG00",LP_MARKET="LPMKT",BCEX="BCEX",QSPC="qspc";var DAILY_PING_ALARM="DDOJ_DAILYPINGALARM",dailyPingAlarmPeriodInMins=1440,bingUrl="https://www.bing.com/",browserDefaultsUrl="https://browserdefaults.microsoft.com/",chromeWS="https://chrome.google.com/",feedbackFwlink="https://go.microsoft.com/fwlink/?linkid=2138838",defaultPC="BG00",manifestData=chrome.runtime.getManifest(),extensionVersion=manifestData.version,extensionId=chrome.runtime.id,extensionUrl="chrome-extension://"+extensionId,market="";try{market=chrome.i18n.getMessage("ExtnMarket")}catch(e){market=navigator.language.toLocaleLowerCase()}var PING_ALARM="DDOJ_PINGALARM";let getPingAlarm=chrome.alarms.get(PING_ALARM);function ddojPingAlarm(e){e||chrome.alarms.create(PING_ALARM,{delayInMinutes:1})}function setBCEXCookie(){new Promise((e=>{"zh-cn"==market?chrome.storage.local.set({[BCEX]:"0"},(()=>{e([BCEX])})):e([BCEX])})).then((()=>{chrome.storage.local.get([BCEX],(e=>{var t=e[BCEX]?e[BCEX]:"1";if(null!=t&&""!=t&&null!=t){var n="";chrome.cookies.get({url:bingUrl,name:"_SS"},(function(e){e&&(n=removeBCEXParameterFromCookie(e.value)+"&BCEX="+t,chrome.cookies.set({url:bingUrl,domain:".bing.com",name:"_SS",value:n,sameSite:"no_restriction",secure:!0},(function(e){})))}))}}))}))}function removeBCEXParameterFromCookie(e){return e.split("&").filter((e=>!e.startsWith("BCEX="))).join("&")}function getBrowserDefaultCookieAndUpdateLocalStorageValues(e,t,n){chrome.cookies.get({url:browserDefaultsUrl,name:chrome.runtime.id},(function(r){setExtensionStorageValues(r,e,t,n)}))}function setExtensionStorageValues(e,t,n,r){readingCookiesAndUpdateChromeStorageValues(e,n).then((e=>{if("installEvent"===t)afterCookieLogicExecution(e),chrome.storage.local.get([PARTNER_CODE],(e=>{addSearchRedirectRule(1,e[PARTNER_CODE],defaultPC,BLOCKING_URL_DDOJ),addBingHomepageRedirectRule(2,e[PARTNER_CODE],defaultPC,BLOCKING_URL_DDOJ_HOMEPAGE)}));else if("fsnEvent"==t){if(-1!=r.indexOf("DPC=BG00")){let e=new URLSearchParams(r);chrome.storage.local.set({PartnerCode:e.get("pc")})}chrome.storage.local.get([PARTNER_CODE,CHANNEL,MACHINE_ID,LP_MARKET,MARKET,BCEX],(e=>{var t=e[LP_MARKET]?e[LP_MARKET]:e[MARKET];t||(t=navigator.language),getLoadData_InstrumentationTracking(e[PARTNER_CODE],t,"ddojnmkongaimkdddgmcccldlfhokcfb",e[CHANNEL],e[BCEX],e[MACHINE_ID],"ExtensionFSN",r)})),chrome.cookies.remove({url:chromeWS,name:"__utmz"}),chrome.cookies.remove({url:browserDefaultsUrl,name:chrome.runtime.id})}}))}function readingCookiesAndUpdateChromeStorageValues(e,t){return new Promise(((n,r)=>{var a={machineId:t,pc:"",channel:"organic",dpc:""};if(e)for(var o=String(e.value).split("&"),i=0;i<o.length;i++){var c=o[i].split("=");"MI"==c[0].toLocaleUpperCase()?a.machineId=c[1]:"CH"==c[0].toLocaleUpperCase()?a.channel=c[1]:"PC"==c[0].toLocaleUpperCase()?a.pc=c[1]:"BM"==c[0].toLocaleUpperCase()?a.bmkt=c[1]:"LPMKT"==c[0].toLocaleUpperCase()?a.iLPMarket=c[1]:"BCEX"==c[0].toLocaleUpperCase()&&(a.iBCEX=c[1])}"organic"==a.channel&&chrome.cookies.get({url:chromeWS,name:"__utmz"},(function(e){if(e){var t=getChromeWSChannel(e.value);""!=t&&(a.channel=t)}})),getValuesinChromeStorage(a).then((e=>{chrome.storage.local.set({[MACHINE_ID]:e.machineId,[PARTNER_CODE]:e.pc,[CHANNEL]:e.channel,[MARKET]:e.bmkt,[DPC]:e.dpc,[LP_MARKET]:e.iLPMarket,[BCEX]:e.iBCEX,[QSPC]:e.qspc},(()=>{setBCEXCookie(),n(e)}))}))}))}function getValuesinChromeStorage(e){return new Promise(((t,n)=>{chrome.storage.local.get([PARTNER_CODE,DPC],(n=>{e.pc?(e.pc=e.pc,e.qspc=e.pc,e.dpc=e.pc+"_"+e.channel,t(e)):(n[PARTNER_CODE]?(e.pc=n[PARTNER_CODE],e.qspc=n[PARTNER_CODE]):(e.pc=defaultPC,e.qspc=defaultPC),n[DPC]?e.dpc=n[DPC]:e.dpc=e.channel,t(e))}))}))}function afterCookieLogicExecution(e){SendPingDetails("1"),chrome.cookies.set({url:bingUrl,domain:".bing.com",name:"_DPC",value:e.dpc},(function(e){}));var t="https://go.microsoft.com/fwlink/?linkid=2128904&trackingid="+chrome.runtime.id+"&partnercode="+e.pc+"&browser=gc";e.iLPMarket?t+="&mkt="+e.iLPMarket:t+="&mkt="+market,e.channel&&(t+="&channel="+e.channel),e.machineId&&(t+="&machineid="+e.machineId),chrome.tabs.create({url:t});var n=e.iLPMarket?e.iLPMarket:e.bmkt;n||(n=navigator.language),chrome.storage.local.get([BCEX],(t=>{getLoadData_InstrumentationTracking(e.pc,n,"ddojnmkongaimkdddgmcccldlfhokcfb",e.channel,t.BCEX,e.machineId,"ExtensionInstall",extensionUrl)}))}function showhtmlpage(){chrome.tabs.create({url:"../Welcomepage/index.html?xid=111&bmkt="+market}),chrome.storage.local.set({ExtensionUpdatepageshown:"True"})}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}var t=e()+e()+e()+e()+e()+e()+e()+e();return t=t.toLocaleUpperCase(),chrome.storage.local.set({[MACHINE_ID]:t}),t}function SendPingDetails(e){var t=navigator.userAgent.indexOf("("),n=navigator.userAgent.indexOf(")"),r=navigator.userAgent.substring(t+1,n).replace(/\s/g,""),a=manifestData.name.replace(/ /g,"").replace(/&/g,"and"),o=navigator.userAgent.substr(navigator.userAgent.indexOf("Chrome")).split(" ")[0].replace("/","");chrome.storage.local.get([PARTNER_CODE,CHANNEL,MACHINE_ID,DPC,LP_MARKET,MARKET],(t=>{var n=t[MARKET]?t[MARKET]:navigator.language,i="https://go.microsoft.com/fwlink/?linkid=2243942&",c="TV=is"+(t[PARTNER_CODE]?t[PARTNER_CODE]:defaultPC)+"|pk"+a+"|tm"+n+"|bv"+o+"|ex"+extensionId+"|es"+e;t[CHANNEL]&&(c=c+"|ch"+t[CHANNEL]),t[DPC]&&(c=c+"|dp"+t[DPC]),t[LP_MARKET]&&(c=c+"|lm"+t[LP_MARKET]);var s="MI="+t[MACHINE_ID]+"&LV="+extensionVersion+"&OS="+r+"&TE=37&"+c;i=i+"UD="+(s=btoa(encodeURI(s)))+"&ver=2",i=encodeURI(i),fetch(i)}))}function getChromeWSChannel(e){var t="",n="",r="",a="",o="",c=e.split(".");if(""!=c[c.length-1]){var s=c[c.length-1].split("|");for(i=0;i<s.length;i++){var l=s[i].split("=");"utmcsr"==l[0]?t=l[1]:"utmccn"==l[0]?n=l[1]:"utmcmd"==l[0]?r=l[1]:"utmcct"==l[0]&&(a=l[1])}return"bgads"==t&&(o=t,"(not%20set)"!=r&&"(direct)"!=r&&"(organic)"!=r&&(o=o+"_"+r),"(not%20set)"!=n&&"(direct)"!=n&&"(organic)"!=n&&(o=o+"_"+n),"(not%20set)"!=a&&"(direct)"!=a&&"(organic)"!=a&&""!=a&&(o=o+"_"+a)),o}}function addSearchRedirectRule(e,t,n,r){if(t||n){var a=[],o={id:e,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"form",value:"BGGCDF"},{key:"pc",value:t||n}]}}}},condition:{urlFilter:r,resourceTypes:["main_frame"]}};a.push(o),chrome.declarativeNetRequest.updateDynamicRules({addRules:a,removeRuleIds:[e]})}}function addBingHomepageRedirectRule(e,t,n,r){if(t||n){var a=[],o={id:e,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"pc",value:t||n}]}}}},condition:{urlFilter:r,resourceTypes:["main_frame"]}};a.push(o),chrome.declarativeNetRequest.updateDynamicRules({addRules:a,removeRuleIds:[e]})}}function getLoadData_InstrumentationTracking(e,t,n,r,a,o,i,c){null!=o&&""!=o&&null!=o||(o=""),null!=r&&""!=r&&null!=r||(r="Organic"),null!=t&&""!=t&&null!=t||(t=""),null!=a&&""!=a&&null!=a||(a="");var s={partnercode:e,os:operatingSystemVersion(),mkt:t,browser:getBrowserVersion(),xid:n,channel:r,machineid:o,browserVersion:navigator.userAgent.substr(navigator.userAgent.indexOf("Chrome")).split(" ")[0].replace("/",""),currenturl:c,eventId:i,bcex:a},l=JSON.stringify(s);fetch("https://browserdefaults.microsoft.com/api/hpinst/InstrumentationTracking",{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"},body:l}).then((e=>{e.ok&&console.log("Success")})).catch((e=>{}))}function operatingSystemVersion(){var e=navigator.userAgent,t="Other";return-1!=e.indexOf("Windows NT 10.0")?t="10":-1!=e.indexOf("Windows NT 6.3")?t="8.1":-1!=e.indexOf("Windows NT 6.2")?t="8":-1!=e.indexOf("Windows NT 6.1")?t="7":-1!=e.indexOf("MAC")&&(t=-1!=e.indexOf("LIKE MAC")?"iOS":"Mac"),t}function getBrowserVersion(){var e=navigator.userAgent;return-1!=e.indexOf("Edg")?"Edge":-1!=e.indexOf("MSIE")||-1!=e.indexOf("Trident")?"IE":-1!=e.indexOf("Chrome")?"Chrome":-1!=e.indexOf("Firefox")?"Firefox":"Others"}getPingAlarm.then(ddojPingAlarm),chrome.alarms.onAlarm.addListener((e=>{e.name===PING_ALARM&&chrome.storage.local.get([MACHINE_ID,"ExtensionUpdated","updatePingSent",DPC,PARTNER_CODE],(e=>{var t=e[DPC];null!=t&&""!=t&&null!=t&&chrome.cookies.set({url:bingUrl,domain:".bing.com",name:"_DPC",value:t},(function(e){})),chrome.cookies.set({url:bingUrl,domain:".bing.com",name:"_NTPC",value:e[PARTNER_CODE]?e[PARTNER_CODE]:defaultPC},(function(e){})),chrome.cookies.set({url:bingUrl,domain:".bing.com",name:"SRCHS",value:"PC="+(e[PARTNER_CODE]?e[PARTNER_CODE]:defaultPC),sameSite:"no_restriction",secure:!0},(function(e){})),"true"==e.ExtensionUpdated&&"false"==e.updatePingSent&&(chrome.storage.local.set({updatePingSent:"true",ExtensionUpdated:"false"}),SendPingDetails("3"));var n=feedbackFwlink+"&extnID="+extensionId+"&mkt="+market+"&mid="+e[MACHINE_ID]+"&br=gc";chrome.runtime.setUninstallURL(n),setBCEXCookie(),addSearchRedirectRule(1,e[PARTNER_CODE],defaultPC,BLOCKING_URL_DDOJ),addBingHomepageRedirectRule(2,e[PARTNER_CODE],defaultPC,BLOCKING_URL_DDOJ_HOMEPAGE)}))})),chrome.runtime.onInstalled.addListener((function(e){"install"==e.reason?(new Promise(((e,t)=>{chrome.storage.local.set({MigratedLocalStorage:!0,ExtnVersion:extensionVersion}),e("organic")})).then((()=>{getBrowserDefaultCookieAndUpdateLocalStorageValues("installEvent",guid(),"")})),chrome.alarms.clear(DAILY_PING_ALARM),chrome.alarms.create(DAILY_PING_ALARM,{delayInMinutes:1,periodInMinutes:dailyPingAlarmPeriodInMins})):"update"==e.reason&&(chrome.storage.local.set({updatePingSent:"false",ExtensionUpdated:"true",showFirstSearchNotification:!1}),chrome.storage.local.get(["ExtnVersion","MigratedLocalStorage","ExtensionUpdatepageshown",PARTNER_CODE],(function(e){e.ExtnVersion&&e.ExtnVersion==chrome.runtime.getManifest().version||(chrome.storage.local.set({ExtnVersion:extensionVersion}),e.MigratedLocalStorage||e.ExtensionUpdatepageshown||showhtmlpage(),addSearchRedirectRule(1,e[PARTNER_CODE],defaultPC,BLOCKING_URL_DDOJ),addBingHomepageRedirectRule(2,e[PARTNER_CODE],defaultPC,BLOCKING_URL_DDOJ_HOMEPAGE))})),chrome.alarms.clear(DAILY_PING_ALARM),chrome.alarms.create(DAILY_PING_ALARM,{delayInMinutes:1,periodInMinutes:dailyPingAlarmPeriodInMins}))})),chrome.alarms.onAlarm.addListener((e=>{e.name===DAILY_PING_ALARM&&chrome.storage.local.get(["showFirstSearchNotification",MACHINE_ID],(e=>{null==e.showFirstSearchNotification?(getBrowserDefaultCookieAndUpdateLocalStorageValues("dailyPingEvent",e[MACHINE_ID],""),SendPingDetails("2")):SendPingDetails("2")}))})),chrome.runtime.onMessage.addListener((function(e){"setMachineID"==e&&chrome.storage.local.get([MACHINE_ID],(e=>{chrome.cookies.set({url:browserDefaultsUrl,domain:".browserdefaults.microsoft.com",name:"MachineID",value:e[MACHINE_ID],sameSite:"no_restriction",secure:!0},(function(e){}))}))})),chrome.action.onClicked.addListener((function(e){var t="https://www.bing.com/?pc="+defaultPC;chrome.storage.local.get([PARTNER_CODE],(e=>{e[PARTNER_CODE]&&(t="https://www.bing.com/?pc="+e[PARTNER_CODE]),chrome.tabs.create({url:t})}))}));